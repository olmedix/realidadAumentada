<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR simple con A-Frame (forzado AR)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <!-- Hit Test para colocar con un toque -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.3.0/dist/aframe-ar-hit-test-component.min.js"></script>

  <style>
    html,body{margin:0;height:100%}
    #start,#recolocar{
      position:fixed;left:50%;transform:translateX(-50%);
      z-index:20;padding:12px 16px;font:600 16px system-ui;border:0;border-radius:12px;
      background:#0ea5e9;color:#fff;box-shadow:0 10px 28px rgba(0,0,0,.25);cursor:pointer
    }
    #start{top:50%}
    #recolocar{bottom:16px;display:none}
    #hint{
      position:fixed;left:0;right:0;top:0;padding:.6rem 1rem;z-index:10;
      color:#fff;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent);
      font:600 14px/1.2 system-ui;pointer-events:none
    }
    a-scene{background:transparent !important}
  </style>
</head>
<body>
  <div id="hint">Mueve el móvil hasta ver el retículo y <b>toca</b> la mesa para colocar el cubo.</div>
  <button id="start">Iniciar AR</button>
  <button id="recolocar">Recolocar</button>

  <a-scene
    embedded
    renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true; alpha:true"
    webxr="mode: ar; optionalFeatures: hit-test, local-floor"
    vr-mode-ui="enabled: false"
    xr-mode-ui="enabled: false">

    <!-- Luces -->
    <a-entity light="type:ambient; intensity:0.7"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0 2 1"></a-entity>

    <!-- Objeto: cubo de 20 cm (oculto hasta colocar) -->
    <a-box id="cubo" visible="false"
           depth="0.2" height="0.2" width="0.2"
           material="color:#FF6A00; metalness:0.2; roughness:0.6">
    </a-box>

    <!-- Retículo + placement con un toque -->
    <a-entity ar-hit-test="target: #cubo"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const startBtn = document.getElementById('start');
    const recolocarBtn = document.getElementById('recolocar');
    const cubo = document.getElementById('cubo');

    // ✅ Pide immersive-ar directamente y conecta la sesión al renderer de A-Frame
    async function startARSession() {
      if (!('xr' in navigator)) {
        alert('Tu navegador no expone navigator.xr');
        return;
      }
      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (!supported) {
        alert('Este navegador/entorno no soporta AR (immersive-ar). Revisa que no esté en "Sitio de escritorio" y que ARCore esté actualizado.');
        return;
      }
      const session = await navigator.xr.requestSession('immersive-ar', {
        optionalFeatures: ['hit-test','local-floor']
      });

      // A-Frame: enlaza la sesión XR manualmente
      const gl = scene.renderer.getContext();
      if (gl.makeXRCompatible) { await gl.makeXRCompatible(); }
      scene.renderer.xr.setSession(session);

      // UI
      startBtn.style.display = 'none';
      session.addEventListener('end', () => {
        startBtn.style.display = 'inline-block';
        recolocarBtn.style.display = 'none';
        cubo.setAttribute('visible', false);
      });
    }

    startBtn.addEventListener('click', () => {
      startARSession().catch(e => alert('No se pudo iniciar AR: ' + (e?.message || e)));
    });

    // Mostrar botón “Recolocar” cuando el cubo se haya colocado
    cubo.addEventListener('componentchanged', (e) => {
      if (e.detail.name === 'visible' && cubo.getAttribute('visible')) {
        recolocarBtn.style.display = 'inline-block';
      }
    });

    // Recolocar: ocultamos el cubo para que el siguiente toque lo ubique de nuevo
    recolocarBtn.addEventListener('click', () => {
      cubo.setAttribute('visible', false);
      recolocarBtn.style.display = 'none';
    });
  </script>
</body>
</html>
