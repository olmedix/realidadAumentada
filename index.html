<html class="a-fullscreen">
  <head>
    <meta charset="utf-8" />
    <title>AR - Con Detección de Rotación</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta aframe-injected="" name="mobile-web-app-capable" content="yes" />
    <meta aframe-injected="" name="theme-color" content="black" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      /* .a-fullscreen means not embedded. */
      html.a-fullscreen {
        bottom: 0;
        left: 0;
        position: fixed;
        right: 0;
        top: 0;
      }

      html.a-fullscreen body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        padding: 0;
        width: 100%;
      }

      /* Class is removed when doing <a-scene embedded>. */
      html.a-fullscreen .a-canvas {
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        position: fixed !important;
      }

      html:not(.a-fullscreen) .a-enter-vr,
      html:not(.a-fullscreen) .a-enter-ar {
        right: 5px;
        bottom: 5px;
      }

      html:not(.a-fullscreen) .a-enter-ar {
        right: 60px;
      }

      /* In chrome mobile the user agent stylesheet set it to white  */
      :-webkit-full-screen {
        background-color: transparent;
      }

      .a-hidden {
        display: none !important;
      }

      .a-canvas {
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
      }

      .a-canvas.a-grab-cursor:hover {
        cursor: grab;
        cursor: -moz-grab;
        cursor: -webkit-grab;
      }

      canvas.a-canvas.a-mouse-cursor-hover:hover {
        cursor: pointer;
      }

      .a-inspector-loader {
        background-color: #ed3160;
        position: fixed;
        left: 3px;
        top: 3px;
        padding: 6px 10px;
        color: #fff;
        text-decoration: none;
        font-size: 12px;
        font-family: Roboto, sans-serif;
        text-align: center;
        z-index: 99999;
        width: 204px;
      }

      /* Inspector loader animation */
      @keyframes dots-1 {
        from {
          opacity: 0;
        }
        25% {
          opacity: 1;
        }
      }
      @keyframes dots-2 {
        from {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }
      @keyframes dots-3 {
        from {
          opacity: 0;
        }
        75% {
          opacity: 1;
        }
      }
      @-webkit-keyframes dots-1 {
        from {
          opacity: 0;
        }
        25% {
          opacity: 1;
        }
      }
      @-webkit-keyframes dots-2 {
        from {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }
      @-webkit-keyframes dots-3 {
        from {
          opacity: 0;
        }
        75% {
          opacity: 1;
        }
      }

      .a-inspector-loader .dots span {
        animation: dots-1 2s infinite steps(1);
        -webkit-animation: dots-1 2s infinite steps(1);
      }

      .a-inspector-loader .dots span:first-child + span {
        animation-name: dots-2;
        -webkit-animation-name: dots-2;
      }

      .a-inspector-loader .dots span:first-child + span + span {
        animation-name: dots-3;
        -webkit-animation-name: dots-3;
      }

      a-scene {
        display: block;
        position: relative;
        height: 100%;
        width: 100%;
      }

      a-assets,
      a-scene video,
      a-scene img,
      a-scene audio {
        display: none;
      }

      .a-enter-vr-modal,
      .a-orientation-modal {
        font-family: Consolas, Andale Mono, Courier New, monospace;
      }

      .a-enter-vr-modal a {
        border-bottom: 1px solid #fff;
        padding: 2px 0;
        text-decoration: none;
        transition: 0.1s color ease-in;
      }

      .a-enter-vr-modal a:hover {
        background-color: #fff;
        color: #111;
        padding: 2px 4px;
        position: relative;
        left: -4px;
      }

      .a-enter-vr,
      .a-enter-ar {
        font-family: sans-serif, monospace;
        font-size: 13px;
        width: 100%;
        font-weight: 200;
        line-height: 16px;
        position: absolute;
        right: 20px;
        bottom: 20px;
      }

      .a-enter-ar {
        right: 80px;
      }

      .a-enter-vr-button,
      .a-enter-vr-modal,
      .a-enter-vr-modal a {
        color: #fff;
        user-select: none;
        outline: none;
      }

      .a-enter-vr-button {
        background: rgba(0, 0, 0, 0.35)
          url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27108%27 height=%2762%27 viewBox=%270 0 108 62%27%3E%3Ctitle%3Eaframe-vrmode-noborder-reduced-tracking%3C/title%3E%3Cpath d=%27M68.81,21.56H64.23v8.27h4.58a4.13,4.13,0,0,0,3.1-1.09,4.2,4.2,0,0,0,1-3,4.24,4.24,0,0,0-1-3A4.05,4.05,0,0,0,68.81,21.56Z%27 fill=%27%23fff%27/%3E%3Cpath d=%27M96,0H12A12,12,0,0,0,0,12V50A12,12,0,0,0,12,62H96a12,12,0,0,0,12-12V12A12,12,0,0,0,96,0ZM41.9,46H34L24,16h8l6,21.84,6-21.84H52Zm39.29,0H73.44L68.15,35.39H64.23V46H57V16H68.81q5.32,0,8.34,2.37a8,8,0,0,1,3,6.69,9.68,9.68,0,0,1-1.27,5.18,8.9,8.9,0,0,1-4,3.34l6.26,12.11Z%27 fill=%27%23fff%27/%3E%3C/svg%3E")
          50% 50% no-repeat;
      }

      .a-enter-ar-button {
        background: rgba(0, 0, 0, 0.2)
          url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27108%27 height=%2762%27 viewBox=%270 0 108 62%27%3E%3Ctitle%3Eaframe-armode-noborder-reduced-tracking%3C/title%3E%3Cpath d=%27M96,0H12A12,12,0,0,0,0,12V50A12,12,0,0,0,12,62H96a12,12,0,0,0,12-12V12A12,12,0,0,0,96,0Zm8,50a8,8,0,0,1-8,8H12a8,8,0,0,1-8-8V12a8,8,0,0,1,8-8H96a8,8,0,0,1,8,8Z%27 fill=%27%23fff%27/%3E%3Cpath d=%27M43.35,39.82H32.51L30.45,46H23.88L35,16h5.73L52,46H45.43Zm-9.17-5h7.5L37.91,23.58Z%27 fill=%27%23fff%27/%3E%3Cpath d=%27M68.11,35H63.18V46H57V16H68.15q5.31,0,8.2,2.37a8.18,8.18,0,0,1,2.88,6.7,9.22,9.22,0,0,1-1.33,5.12,9.09,9.09,0,0,1-4,3.26l6.49,12.26V46H73.73Zm-4.93-5h5a5.09,5.09,0,0,0,3.6-1.18,4.21,4.21,0,0,0,1.28-3.27,4.56,4.56,0,0,0-1.2-3.34A5,5,0,0,0,68.15,21h-5Z%27 fill=%27%23fff%27/%3E%3C/svg%3E")
          50% 50% no-repeat;
      }

      .a-enter-vr.fullscreen .a-enter-vr-button {
        background-image: url("data:image/svg+xml,%3C%3Fxml version=%271.0%27 encoding=%27UTF-8%27 standalone=%27no%27%3F%3E%3Csvg width=%27108%27 height=%2762%27 viewBox=%270 0 108 62%27 version=%271.1%27 id=%27svg320%27 sodipodi:docname=%27fullscreen-aframe.svg%27 xml:space=%27preserve%27 inkscape:version=%271.2.1 %289c6d41e  2022-07-14%29%27 xmlns:inkscape=%27http://www.inkscape.org/namespaces/inkscape%27 xmlns:sodipodi=%27http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd%27 xmlns=%27http://www.w3.org/2000/svg%27 xmlns:svg=%27http://www.w3.org/2000/svg%27 xmlns:rdf=%27http://www.w3.org/1999/02/22-rdf-syntax-ns%23%27 xmlns:cc=%27http://creativecommons.org/ns%23%27 xmlns:dc=%27http://purl.org/dc/elements/1.1/%27%3E%3Cdefs id=%27defs324%27 /%3E%3Csodipodi:namedview id=%27namedview322%27 pagecolor=%27%23ffffff%27 bordercolor=%27%23000000%27 borderopacity=%270.25%27 inkscape:showpageshadow=%272%27 inkscape:pageopacity=%270.0%27 inkscape:pagecheckerboard=%270%27 inkscape:deskcolor=%27%23d1d1d1%27 showgrid=%27false%27 inkscape:zoom=%273.8064516%27 inkscape:cx=%2791.423729%27 inkscape:cy=%27-1.4449153%27 inkscape:window-width=%271440%27 inkscape:window-height=%27847%27 inkscape:window-x=%2732%27 inkscape:window-y=%2725%27 inkscape:window-maximized=%270%27 inkscape:current-layer=%27svg320%27 /%3E%3Ctitle id=%27title312%27%3Eaframe-armode-noborder-reduced-tracking%3C/title%3E%3Cpath d=%27M96 0H12A12 0 0 0 0 12V50A12 12 0 0 0 12 62H96a12 12 0 0 0 12-12V12A12 12 0 0 0 96 0Zm8 50a8 8 0 0 1-8 8H12a8 8 0 0 1-8-8V12a8 8 0 0 1,8-8H96a8 8 0 0 1,8,8Z%27 fill=%27%23fff%27 id=%27path314%27 style=%27fill:%23ffffff%27 /%3E%3Cg id=%27g356%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g358%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g360%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g362%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g364%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g366%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g368%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g370%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g372%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g374%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g376%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g378%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g380%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g382%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cg id=%27g384%27 transform=%27translate%28-206.61017 -232.61864%29%27%3E%3C/g%3E%3Cmetadata id=%27metadata561%27%3E%3Crdf:RDF%3E%3Ccc:Work rdf:about=%27%27%3E%3Cdc:title%3Eaframe-armode-noborder-reduced-tracking%3C/dc:title%3E%3C/cc:Work%3E%3C/rdf:RDF%3E%3C/metadata%3E%3Cpath d=%27m 98.168511 40.083649 c 0 -1.303681 -0.998788 -2.358041 -2.239389 -2.358041 -1.230088 0.0031 -2.240892 1.05436 -2.240892 2.358041 v 4.881296 l -9.041661 -9.041662 c -0.874129 -0.875631 -2.288954 -0.875631 -3.16308 0 -0.874129 0.874126 -0.874129 2.293459 0 3.167585 l 8.995101 8.992101 h -4.858767 c -1.323206 0.0031 -2.389583 1.004796 -2.389583 2.239386 0 1.237598 1.066377 2.237888 2.389583 2.237888 h 10.154599 c 1.323206 0 2.388082 -0.998789 2.392587 -2.237888 -0.0044 -0.03305 -0.009 -0.05858 -0.0134 -0.09161 0.0046 -0.04207 0.0134 -0.08712 0.0134 -0.13066 V 40.085172 h -1.52e-4%27 id=%27path596%27 style=%27fill:%23ffffff%3Bstroke-width:1.50194%27 /%3E%3Cpath d=%27m 23.091002 35.921781 -9.026643 9.041662 v -4.881296 c 0 -1.303681 -1.009302 -2.355037 -2.242393 -2.358041 -1.237598 0 -2.237888 1.05436 -2.237888 2.358041 l -0.0031 10.016421 c 0 0.04356 0.01211 0.08862 0.0015 0.130659 -0.0031 0.03153 -0.009 0.05709 -0.01211 0.09161 0.0031 1.239099 1.069379 2.237888 2.391085 2.237888 h 10.156101 c 1.320202 0 2.388079 -1.000291 2.388079 -2.237888 0 -1.234591 -1.067877 -2.236383 -2.388079 -2.239387 h -4.858767 l 8.995101 -8.9921 c 0.871126 -0.874127 0.871126 -2.293459 0 -3.167586 -0.875628 -0.877132 -2.291957 -0.877132 -3.169087 -1.52e-4%27 id=%27path598%27 style=%27fill:%23ffffff%3Bstroke-width:1.50194%27 /%3E%3Cpath d=%27m 84.649572 25.978033 9.041662 -9.041664 v 4.881298 c 0 1.299176 1.010806 2.350532 2.240891 2.355037 1.240601 0 2.23939 -1.055861 2.23939 -2.355037 V 11.798242 c 0 -0.04356 -0.009 -0.08862 -0.0134 -0.127671 0.0044 -0.03153 0.009 -0.06157 0.0134 -0.09313 -0.0044 -1.240598 -1.069379 -2.2393873 -2.391085 -2.2393873 h -10.1546 c -1.323205 0 -2.38958 0.9987893 -2.38958 2.2393873 0 1.233091 1.066375 2.237887 2.38958 2.240891 h 4.858768 l -8.995102 8.9921 c -0.874129 0.872625 -0.874129 2.288954 0 3.161578 0.874127 0.880137 2.288951 0.880137 3.16308 1.5e-4%27 id=%27path600%27 style=%27fill:%23ffffff%3Bstroke-width:1.50194%27 /%3E%3Cpath d=%27m 17.264988 13.822853 h 4.857265 c 1.320202 -0.0031 2.388079 -1.0078 2.388079 -2.240889 0 -1.240601 -1.067877 -2.2393893 -2.388079 -2.2393893 H 11.967654 c -1.321707 0 -2.388082 0.9987883 -2.391085 2.2393893 0.0031 0.03153 0.009 0.06157 0.01211 0.09313 -0.0031 0.03905 -0.0015 0.08262 -0.0015 0.127671 l 0.0031 10.020926 c 0 1.299176 1.00029 2.355038 2.237887 2.355038 1.233092 -0.0044 2.242393 -1.055862 2.242393 -2.355038 v -4.881295 l 9.026644 9.041661 c 0.877132 0.878635 2.293459 0.878635 3.169087 0 0.871125 -0.872624 0.871125 -2.288953 0 -3.161577 l -8.995282 -8.993616%27 id=%27path602%27 style=%27fill:%23ffffff%3Bstroke-width:1.50194%27 /%3E%3C/svg%3E");
      }

      .a-enter-vr-button,
      .a-enter-ar-button {
        background-size: 90% 90%;
        border: 0;
        bottom: 0;
        cursor: pointer;
        min-width: 58px;
        min-height: 34px;
        /* 1.74418604651 */
        /*
    In order to keep the aspect ratio when resizing
    padding-top percentages are relative to the containing block's width.
    http://stackoverflow.com/questions/12121090/responsively-change-div-size-keeping-aspect-ratio
  */
        padding-right: 0;
        padding-top: 0;
        position: absolute;
        right: 0;
        transition: background-color 0.05s ease;
        -webkit-transition: background-color 0.05s ease;
        z-index: 9999;
        border-radius: 8px;
        touch-action: manipulation; /* Prevent iOS double tap zoom on the button */
      }

      .a-enter-ar-button {
        background-size: 100% 90%;
        margin-right: 10px;
        border-radius: 7px;
      }

      .a-enter-ar-button:active,
      .a-enter-ar-button:hover,
      .a-enter-vr-button:active,
      .a-enter-vr-button:hover {
        background-color: #ef2d5e;
      }

      .a-enter-vr-button.resethover {
        background-color: rgba(0, 0, 0, 0.35);
      }

      .a-enter-vr-modal {
        background-color: #666;
        border-radius: 0;
        display: none;
        min-height: 32px;
        margin-right: 70px;
        padding: 9px;
        width: 280px;
        right: 2%;
        position: absolute;
      }

      .a-enter-vr-modal:after {
        border-bottom: 10px solid transparent;
        border-left: 10px solid #666;
        border-top: 10px solid transparent;
        display: inline-block;
        content: "";
        position: absolute;
        right: -5px;
        top: 5px;
        width: 0;
        height: 0;
      }

      .a-enter-vr-modal p,
      .a-enter-vr-modal a {
        display: inline;
      }

      .a-enter-vr-modal p {
        margin: 0;
      }

      .a-enter-vr-modal p:after {
        content: " ";
      }

      .a-orientation-modal {
        background: rgba(244, 244, 244, 1)
          url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%20version%3D%221.1%22%20x%3D%220px%22%20y%3D%220px%22%20viewBox%3D%220%200%2090%2090%22%20enable-background%3D%22new%200%200%2090%2090%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpolygon%20points%3D%220%2C0%200%2C0%200%2C0%20%22%3E%3C/polygon%3E%3Cg%3E%3Cpath%20d%3D%22M71.545%2C48.145h-31.98V20.743c0-2.627-2.138-4.765-4.765-4.765H18.456c-2.628%2C0-4.767%2C2.138-4.767%2C4.765v42.789%20%20%20c0%2C2.628%2C2.138%2C4.766%2C4.767%2C4.766h5.535v0.959c0%2C2.628%2C2.138%2C4.765%2C4.766%2C4.765h42.788c2.628%2C0%2C4.766-2.137%2C4.766-4.765V52.914%20%20%20C76.311%2C50.284%2C74.173%2C48.145%2C71.545%2C48.145z%20M18.455%2C16.935h16.344c2.1%2C0%2C3.808%2C1.708%2C3.808%2C3.808v27.401H37.25V22.636%20%20%20c0-0.264-0.215-0.478-0.479-0.478H16.482c-0.264%2C0-0.479%2C0.214-0.479%2C0.478v36.585c0%2C0.264%2C0.215%2C0.478%2C0.479%2C0.478h7.507v7.644%20%20%20h-5.534c-2.101%2C0-3.81-1.709-3.81-3.81V20.743C14.645%2C18.643%2C16.354%2C16.935%2C18.455%2C16.935z%20M16.96%2C23.116h19.331v25.031h-7.535%20%20%20c-2.628%2C0-4.766%2C2.139-4.766%2C4.768v5.828h-7.03V23.116z%20M71.545%2C73.064H28.757c-2.101%2C0-3.81-1.708-3.81-3.808V52.914%20%20%20c0-2.102%2C1.709-3.812%2C3.81-3.812h42.788c2.1%2C0%2C3.809%2C1.71%2C3.809%2C3.812v16.343C75.354%2C71.356%2C73.645%2C73.064%2C71.545%2C73.064z%22%3E%3C/path%3E%3Cpath%20d%3D%22M28.919%2C58.424c-1.466%2C0-2.659%2C1.193-2.659%2C2.66c0%2C1.466%2C1.193%2C2.658%2C2.659%2C2.658c1.468%2C0%2C2.662-1.192%2C2.662-2.658%20%20%20C31.581%2C59.617%2C30.387%2C58.424%2C28.919%2C58.424z%20M28.919%2C62.786c-0.939%2C0-1.703-0.764-1.703-1.702c0-0.939%2C0.764-1.704%2C1.703-1.704%20%20%20c0.94%2C0%2C1.705%2C0.765%2C1.705%2C1.704C30.623%2C62.022%2C29.858%2C62.786%2C28.919%2C62.786z%22%3E%3C/path%3E%3Cpath%20d%3D%22M69.654%2C50.461H33.069c-0.264%2C0-0.479%2C0.215-0.479%2C0.479v20.288c0%2C0.264%2C0.215%2C0.478%2C0.479%2C0.478h36.585%20%20%20c0.263%2C0%2C0.477-0.214%2C0.477-0.478V50.939C70.131%2C50.676%2C69.917%2C50.461%2C69.654%2C50.461z%20M69.174%2C51.417V70.75H33.548V51.417H69.174z%22%3E%3C/path%3E%3Cpath%20d%3D%22M45.201%2C30.296c6.651%2C0%2C12.233%2C5.351%2C12.551%2C11.977l-3.033-2.638c-0.193-0.165-0.507-0.142-0.675%2C0.048%20%20%20c-0.174%2C0.198-0.153%2C0.501%2C0.045%2C0.676l3.883%2C3.375c0.09%2C0.075%2C0.198%2C0.115%2C0.312%2C0.115c0.141%2C0%2C0.273-0.061%2C0.362-0.166%20%20%20l3.371-3.877c0.173-0.2%2C0.151-0.502-0.047-0.675c-0.194-0.166-0.508-0.144-0.676%2C0.048l-2.592%2C2.979%20%20%20c-0.18-3.417-1.629-6.605-4.099-9.001c-2.538-2.461-5.877-3.817-9.404-3.817c-0.264%2C0-0.479%2C0.215-0.479%2C0.479%20%20%20C44.72%2C30.083%2C44.936%2C30.296%2C45.201%2C30.296z%22%3E%3C/path%3E%3C/g%3E%3C/svg%3E")
          center no-repeat;
        background-size: 50% 50%;
        bottom: 0;
        font-size: 14px;
        font-weight: 600;
        left: 0;
        line-height: 20px;
        right: 0;
        position: fixed;
        top: 0;
        z-index: 9999999;
      }

      .a-orientation-modal:after {
        color: #666;
        content: "Insert phone into Cardboard holder.";
        display: block;
        position: absolute;
        text-align: center;
        top: 70%;
        transform: translateY(-70%);
        width: 100%;
      }

      .a-orientation-modal button {
        background: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%20version%3D%221.1%22%20x%3D%220px%22%20y%3D%220px%22%20viewBox%3D%220%200%20100%20100%22%20enable-background%3D%22new%200%200%20100%20100%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M55.209%2C50l17.803-17.803c1.416-1.416%2C1.416-3.713%2C0-5.129c-1.416-1.417-3.713-1.417-5.129%2C0L50.08%2C44.872%20%20L32.278%2C27.069c-1.416-1.417-3.714-1.417-5.129%2C0c-1.417%2C1.416-1.417%2C3.713%2C0%2C5.129L44.951%2C50L27.149%2C67.803%20%20c-1.417%2C1.416-1.417%2C3.713%2C0%2C5.129c0.708%2C0.708%2C1.636%2C1.062%2C2.564%2C1.062c0.928%2C0%2C1.856-0.354%2C2.564-1.062L50.08%2C55.13l17.803%2C17.802%20%20c0.708%2C0.708%2C1.637%2C1.062%2C2.564%2C1.062s1.856-0.354%2C2.564-1.062c1.416-1.416%2C1.416-3.713%2C0-5.129L55.209%2C50z%22%3E%3C/path%3E%3C/svg%3E")
          no-repeat;
        border: none;
        height: 50px;
        text-indent: -9999px;
        width: 50px;
      }

      .a-loader-title {
        background-color: rgba(0, 0, 0, 0.6);
        font-family: sans-serif, monospace;
        text-align: center;
        font-size: 20px;
        height: 50px;
        font-weight: 300;
        line-height: 50px;
        position: absolute;
        right: 0px;
        left: 0px;
        top: 0px;
        color: white;
      }

      .a-modal {
        position: absolute;
        background: rgba(0, 0, 0, 0.6);
        background-size: 50% 50%;
        bottom: 0;
        font-size: 14px;
        font-weight: 600;
        left: 0;
        line-height: 20px;
        right: 0;
        position: fixed;
        top: 0;
        z-index: 9999999;
      }

      .a-dialog {
        position: relative;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 199995;
        width: 300px;
        height: 200px;
        background-size: contain;
        background-color: white;
        font-family: sans-serif, monospace;
        font-size: 20px;
        border-radius: 3px;
        padding: 6px;
      }

      .a-dialog-text-container {
        width: 100%;
        height: 70%;
        align-self: flex-start;
        display: flex;
        justify-content: center;
        align-content: center;
        flex-direction: column;
      }

      .a-dialog-text {
        display: inline-block;
        font-weight: normal;
        font-size: 14pt;
        margin: 8px;
      }

      .a-dialog-buttons-container {
        display: inline-flex;
        align-self: flex-end;
        width: 100%;
        height: 30%;
      }

      .a-dialog-button {
        cursor: pointer;
        align-self: center;
        opacity: 0.9;
        height: 80%;
        width: 50%;
        font-size: 12pt;
        margin: 4px;
        border-radius: 2px;
        text-align: center;
        border: none;
        display: inline-block;
        -webkit-transition: all 0.25s ease-in-out;
        transition: all 0.25s ease-in-out;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.2);
        user-select: none;
      }

      .a-dialog-permission-button:hover {
        box-shadow: 0 7px 14px rgba(0, 0, 0, 0.2), 0 2px 2px rgba(0, 0, 0, 0.2);
      }

      .a-dialog-allow-button {
        background-color: #00ceff;
      }

      .a-dialog-deny-button {
        background-color: #ff005b;
      }

      .a-dialog-ok-button {
        background-color: #00ceff;
        width: 100%;
      }

      .a-dom-overlay:not(.a-no-style) {
        overflow: hidden;
        position: absolute;
        pointer-events: none;
        box-sizing: border-box;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
        padding: 1em;
      }

      .a-dom-overlay:not(.a-no-style) > * {
        pointer-events: auto;
      }
    </style>
    <style>
      .rs-base {
        background-color: #333;
        color: #fafafa;
        border-radius: 0;
        font: 10px monospace;
        left: 5px;
        line-height: 1em;
        opacity: 0.85;
        overflow: hidden;
        padding: 10px;
        position: fixed;
        top: 5px;
        width: 300px;
        z-index: 10000;
      }

      .rs-base div.hidden {
        display: none;
      }

      .rs-base h1 {
        color: #fff;
        cursor: pointer;
        font-size: 1.4em;
        font-weight: 300;
        margin: 0 0 5px;
        padding: 0;
      }

      .rs-group {
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-flex-direction: column-reverse;
        flex-direction: column-reverse;
        margin-bottom: 5px;
      }

      .rs-group:last-child {
        margin-bottom: 0;
      }

      .rs-counter-base {
        align-items: center;
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        height: 10px;
        -webkit-justify-content: space-between;
        justify-content: space-between;
        margin: 2px 0;
      }

      .rs-counter-base.alarm {
        color: #b70000;
        text-shadow: 0 0 0 #b70000, 0 0 1px #fff, 0 0 1px #fff, 0 0 2px #fff,
          0 0 2px #fff, 0 0 3px #fff, 0 0 3px #fff, 0 0 4px #fff, 0 0 4px #fff;
      }

      .rs-counter-id {
        font-weight: 300;
        -webkit-box-ordinal-group: 0;
        -webkit-order: 0;
        order: 0;
        width: 54px;
      }

      .rs-counter-value {
        font-weight: 300;
        -webkit-box-ordinal-group: 1;
        -webkit-order: 1;
        order: 1;
        text-align: right;
        width: 35px;
      }

      .rs-canvas {
        -webkit-box-ordinal-group: 2;
        -webkit-order: 2;
        order: 2;
      }

      @media (min-width: 480px) {
        .rs-base {
          left: 20px;
          top: 20px;
        }
      }
    </style>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas
      id="analysis-canvas"
      width="96"
      height="72"
      style="display: none"
    ></canvas>
    <video
      id="cam"
      autoplay=""
      muted=""
      playsinline=""
      style="display: none"
      crossorigin="anonymous"
      webkit-playsinline=""
    ></video>

    <a-scene
      inspector=""
      keyboard-shortcuts=""
      screenshot=""
      vr-mode-ui=""
      device-orientation-permission-ui=""
    >
      <!-- Cuadrícula transparente -->
      <a-plane
        rotation="-90 0 0"
        width="100"
        height="100"
        position="0 0 0"
        material="shader: flat; wireframe: true; wireframeLinewidth: 2; color: #1a1a1a; transparent: true; opacity: 0.3"
        geometry=""
      >
      </a-plane>

      <!-- Marcadores -->
      <a-text
        value="INICIO"
        position="0 0.5 0"
        rotation="0 0 0"
        color="#00FF00"
        align="center"
        width="8"
        text=""
      ></a-text>
      <a-text
        value="5m"
        position="0 0.5 -5"
        rotation="0 0 0"
        color="#4CC3D9"
        align="center"
        width="6"
        text=""
      ></a-text>
      <a-text
        value="10m"
        position="0 0.5 -10"
        rotation="0 0 0"
        color="#FFC65D"
        align="center"
        width="6"
        text=""
      ></a-text>
      <a-text
        value="15m"
        position="0 0.5 -15"
        rotation="0 0 0"
        color="#FF6B6B"
        align="center"
        width="6"
        text=""
      ></a-text>

      <!-- Robot -->
      <!-- gltf-model="url(assets/modelo.glb)" -->
      <a-entity
        id="robot"
        position="0 2.5 -2"
        scale="1 1 1"
        proximity-loader="rig: #rig; threshold: 5; src: url(assets/modelo.glb)"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"
      >
      </a-entity>

      <!-- Silkong -->
      <a-entity
        id="silkong"
        position="2 2.5 -4"
        scale="1 1 1"
        proximity-loader="rig: #rig; threshold: 5; src: url(assets/silksong.glb)"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000;
        easing: linear"
      >
      </a-entity>

      <!-- Kawasaki -->
      <a-entity
        id="kawasaki"
        position="-2 2.5 -5"
        scale="1 1 1"
        proximity-loader="rig: #rig; loadDist: 2; unloadDist: 3.5; src: url(assets/kawasaki.glb)"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000;
        easing: linear"
      >
      </a-entity>

      <a-light
        type="directional"
        intensity="0.7"
        position="2 4 2"
        light=""
      ></a-light>
      <a-light type="ambient" intensity="0.5" light=""></a-light>

      <!-- RIG -->
      <a-entity id="rig" position="0 1.6 0" rotation-aware-flow="">
        <a-entity
          camera=""
          look-controls="pointerLockEnabled: false; touchEnabled: true"
          position=""
          rotation=""
        >
          <!-- Video de fondo -->
          <a-plane
            position="0 1.2 -7"
            width="15"
            height="13"
            material="shader: flat; src: #cam; transparent: true; opacity: 0.6"
            geometry=""
          >
          </a-plane>

          <!-- HUD DEBUG -->
          <a-plane
            position="-0.24 0.34 -0.6"
            width="0.46"
            height="0.56"
            color="#000000"
            material="shader: flat; transparent: true; opacity: 0.88"
            geometry=""
          >
          </a-plane>

          <a-text
            value="ROT-AWARE"
            position="-0.24 0.62 -0.59"
            width="0.65"
            color="#4CC3D9"
            align="center"
            text=""
          ></a-text>

          <!-- Profundidad -->
          <a-text
            value="PROFUNDIDAD"
            position="-0.24 0.57 -0.59"
            width="0.5"
            color="#FFC65D"
            align="center"
            text=""
          ></a-text>

          <a-text
            id="hud-depth"
            value="→ AVANZA"
            position="-0.24 0.52 -0.59"
            width="0.75"
            color="#00FF00"
            align="center"
            text=""
          ></a-text>

          <a-text
            id="hud-depth-val"
            value="0.05"
            position="-0.24 0.48 -0.59"
            width="0.6"
            color="#FFFFFF"
            align="center"
            text=""
          ></a-text>

          <!-- Barra profundidad -->
          <a-plane
            position="-0.24 0.43 -0.59"
            width="0.38"
            height="0.025"
            color="#222222"
            material=""
            geometry=""
          ></a-plane>
          <a-plane
            id="hud-bar-depth"
            position="-0.24 0.43 -0.589"
            width="0.19"
            height="0.022"
            color="#00FF00"
            material=""
            geometry=""
          ></a-plane>
          <a-plane
            position="-0.24 0.43 -0.588"
            width="0.003"
            height="0.025"
            color="#FFFFFF"
            material=""
            geometry=""
          ></a-plane>

          <!-- Lateral -->
          <a-text
            value="LATERAL"
            position="-0.24 0.38 -0.59"
            width="0.5"
            color="#FFC65D"
            align="center"
            text=""
          ></a-text>

          <a-text
            id="hud-lateral"
            value="CENTRO"
            position="-0.24 0.33 -0.59"
            width="0.75"
            color="#999"
            align="center"
            text=""
          ></a-text>

          <a-text
            id="hud-lateral-val"
            value="-0.00"
            position="-0.24 0.29 -0.59"
            width="0.6"
            color="#FFFFFF"
            align="center"
            text=""
          ></a-text>

          <!-- Barra lateral -->
          <a-plane
            position="-0.24 0.24 -0.59"
            width="0.38"
            height="0.025"
            color="#222222"
            material=""
            geometry=""
          ></a-plane>
          <a-plane
            id="hud-bar-lateral"
            position="-0.24 0.24 -0.589"
            width="0"
            height="0.022"
            color="#4CC3D9"
            material=""
            geometry=""
          ></a-plane>
          <a-plane
            position="-0.24 0.24 -0.588"
            width="0.003"
            height="0.025"
            color="#FFFFFF"
            material=""
            geometry=""
          ></a-plane>

          <!-- Estado -->
          <a-text
            id="hud-rotating"
            value="Rotando: NO"
            position="-0.40 0.19 -0.59"
            width="0.5"
            color="#00FF00"
            align="left"
            text=""
          ></a-text>

          <a-text
            id="hud-blocks-z"
            value="BlqZ: 2"
            position="-0.40 0.16 -0.59"
            width="0.5"
            color="#FFF"
            align="left"
            text=""
          ></a-text>

          <a-text
            id="hud-blocks-x"
            value="BlqX: 0"
            position="-0.40 0.13 -0.59"
            width="0.5"
            color="#FFF"
            align="left"
            text=""
          ></a-text>

          <a-text
            id="hud-pos"
            value="X:1.5 Z:12.7"
            position="-0.40 0.10 -0.59"
            width="0.5"
            color="#FFC65D"
            align="left"
            text=""
          ></a-text>

          <a-text
            id="hud-robot-pos"
            value="Robot: X:0.0 Y:0.0 Z:0.0"
            position="-0.40 0.07 -0.59"
            width="0.5"
            color="#FFEE66"
            align="left"
            text=""
          ></a-text>

          <a-text
            id="hud-fps"
            value="FPS:27"
            position="-0.40 0.04 -0.59"
            width="0.5"
            color="#666"
            align="left"
            text=""
          ></a-text>
        </a-entity>
      </a-entity>

      <!-- Fin de DEBUG VR -->

      <!-- Botones para entrar en modo VR o AR -->
      <canvas
        class="a-canvas a-grab-cursor"
        data-aframe-canvas="true"
        data-engine="three.js r147"
        width="1185"
        height="911"
      ></canvas>
      <div class="a-loader-title" style="display: none">
        AR - Con Detección de Rotación
      </div>
      <div class="a-enter-vr fullscreen" aframe-injected="">
        <button
          class="a-enter-vr-button"
          title="Enter VR mode with a headset or fullscreen without"
          aframe-injected=""
        ></button>
      </div>
      <div class="a-enter-ar a-hidden" aframe-injected="">
        <button
          class="a-enter-ar-button"
          title="Enter AR mode with a headset or handheld device."
          aframe-injected=""
        ></button>
      </div>
      <div class="a-orientation-modal a-hidden" aframe-injected="">
        <button aframe-injected="">Exit VR</button>
      </div></a-scene
    >

    <script>
      // ========================================
      // CARGA MODELOS 3D CON PROXIMITY-LOADER
      // ========================================
      AFRAME.registerComponent("proximity-loader", {
        schema: {
          rig: { type: "selector" },
          loadDist: { type: "number", default: 2 },
          unloadDist: { type: "number", default: 3.5 },
          src: { type: "string" },
        },
        init: function () {
          this.triggered = false;
          this.loaded = false;
          this.el.setAttribute("visible", false);

          // Cuando el modelo termine de cargarse
          this.el.addEventListener("model-loaded", () => {
            this.loaded = true;
            this.el.setAttribute("visible", true);
          });
        },
        tick: function () {
          if (!this.data.rig) return;

          const rigZ = this.data.rig.object3D.position.z;
          const objZ = this.el.object3D.position.z;
          const dz = Math.abs(objZ - rigZ);

          // ----------- CARGAR -----------
          if (!this.loaded && dz < this.data.loadDist) {
            this.el.setAttribute("gltf-model", this.data.src);
            return;
          }

          // ----------- DESCARGAR -----------
          if (this.loaded && dz > this.data.unloadDist) {
            this.el.removeAttribute("gltf-model");
            this.el.setAttribute("visible", false);
            this.loaded = false;
            return;
          }
        },
      });

      // ========================================
      // CON DETECCIÓN DE ROTACIÓN
      // ========================================
      AFRAME.registerComponent("rotation-aware-flow", {
        schema: {
          speedZ: { type: "number", default: 8.0 },
          speedX: { type: "number", default: 6.0 },
          sensitivityZ: { type: "number", default: 1 },
          sensitivityX: { type: "number", default: 0.6 },
          friction: { type: "number", default: 0.95 },
          thresholdZ: { type: "number", default: 0.09 },
          thresholdX: { type: "number", default: 0.6 },
          smoothing: { type: "number", default: 0.85 },
          lateralSmoothing: { type: "number", default: 0.95 },
          blockSize: { type: "number", default: 8 },
          searchRange: { type: "number", default: 4 },
          // Gyro sensor options
          useGyro: { type: "boolean", default: true },
          gyroThreshold: { type: "number", default: 20 }, // deg/s
          gyroHysteresis: { type: "number", default: 2 }, // frames para activar
        },

        init: function () {
          this.sensorRotating = false;
          this.sensorRotationCounter = 0;
          this._gyro = null;
          this._devicemotionHandler = null;
          if (this.data.useGyro) {
            // Prefer Generic Sensor API
            try {
              if ("Gyroscope" in window) {
                this._gyro = new Gyroscope({ frequency: 60 });
                this._gyro.addEventListener("reading", () => {
                  // Gyroscope gives rad/s -> convert to deg/s
                  const ax = Math.abs(this._gyro.x || 0) * (180 / Math.PI);
                  const ay = Math.abs(this._gyro.y || 0) * (180 / Math.PI);
                  const az = Math.abs(this._gyro.z || 0) * (180 / Math.PI);
                  const ang = Math.max(ax, ay, az);
                  if (ang > this.data.gyroThreshold)
                    this.sensorRotationCounter = Math.min(
                      10,
                      this.sensorRotationCounter + 1
                    );
                  else
                    this.sensorRotationCounter = Math.max(
                      0,
                      this.sensorRotationCounter - 1
                    );
                  this.sensorRotating =
                    this.sensorRotationCounter >= this.data.gyroHysteresis;
                });
                this._gyro.start();
              } else if (window.DeviceMotionEvent) {
                // Fallback: DeviceMotionEvent.rotationRate (deg/s)
                this._devicemotionHandler = (e) => {
                  const rr = e.rotationRate;
                  if (!rr) return;
                  const a = Math.max(
                    Math.abs(rr.alpha || 0),
                    Math.abs(rr.beta || 0),
                    Math.abs(rr.gamma || 0)
                  );
                  if (a > this.data.gyroThreshold)
                    this.sensorRotationCounter = Math.min(
                      10,
                      this.sensorRotationCounter + 1
                    );
                  else
                    this.sensorRotationCounter = Math.max(
                      0,
                      this.sensorRotationCounter - 1
                    );
                  this.sensorRotating =
                    this.sensorRotationCounter >= this.data.gyroHysteresis;
                };
                window.addEventListener(
                  "devicemotion",
                  this._devicemotionHandler,
                  { passive: true }
                );
              }
            } catch (err) {
              console.warn("Gyro init failed:", err);
            }
          }

          this.canvas = document.getElementById("analysis-canvas");
          this.ctx = this.canvas.getContext("2d");
          this.width = this.canvas.width;
          this.height = this.canvas.height;
          this.centerX = this.width / 2;
          this.centerY = this.height / 2;

          this.video = document.getElementById("cam");

          this.prevFrame = null;
          this.currFrame = null;

          this.velocityZ = 0;
          this.velocityX = 0;

          this.smoothFlowZ = 0;
          this.smoothFlowX = 0;

          this.isRotating = false;
          this.rotationCounter = 0; // contador para histéresis en detección de rotación

          this.frameCount = 0;
          this.lastFpsTime = Date.now();
          this.fps = 0;

          this.hud = {
            depth: document.getElementById("hud-depth"),
            depthVal: document.getElementById("hud-depth-val"),
            barDepth: document.getElementById("hud-bar-depth"),
            lateral: document.getElementById("hud-lateral"),
            lateralVal: document.getElementById("hud-lateral-val"),
            barLateral: document.getElementById("hud-bar-lateral"),
            rotating: document.getElementById("hud-rotating"),
            blocksZ: document.getElementById("hud-blocks-z"),
            blocksX: document.getElementById("hud-blocks-x"),
            pos: document.getElementById("hud-pos"),
            robotPos: document.getElementById("hud-robot-pos"),
            fps: document.getElementById("hud-fps"),
          };

          // Referencia a la cámara del rig
          this.camEl =
            this.el.querySelector("[camera]") || this.el.sceneEl.camera.el;

          // Vectores de trabajo para movimiento
          this._forward = new THREE.Vector3();
          this._right = new THREE.Vector3();
          this._up = new THREE.Vector3(0, 1, 0);

          this.robotEl = document.getElementById("robot");

          this.video.addEventListener("loadeddata", () => {
            console.log("✓ Video OK");
            this.startAnalysis();
          });
        },

        startAnalysis: function () {
          this.analyzeFrame();
        },

        // Función para el analisis de datos
        analyzeFrame: function () {
          if (this.video.readyState !== 4) {
            requestAnimationFrame(() => this.analyzeFrame());
            return;
          }

          this.ctx.drawImage(this.video, 0, 0, this.width, this.height);
          const imageData = this.ctx.getImageData(
            0,
            0,
            this.width,
            this.height
          );

          if (this.currFrame) {
            this.prevFrame = this.currFrame;
          }
          this.currFrame = imageData;
          // PRECALCULAR canales en gris para acelerar comparaciones
          // mover prevGray antes de sobrescribir currGray
          if (!this.currGray)
            this.currGray = new Uint8Array(this.width * this.height);
          if (!this.prevGray)
            this.prevGray = new Uint8Array(this.width * this.height);
          // swap buffers: prevGray <- currGray (si existía)
          if (this.prevFrame) {
            this.prevGray = this.currGray;
          }
          // rellenar currGray desde imageData
          this.currGray = new Uint8Array(this.width * this.height);
          const d = this.currFrame.data;
          for (let i = 0, p = 0; i < d.length; i += 4, p++) {
            this.currGray[p] = ((d[i] + d[i + 1] + d[i + 2]) / 3) | 0;
          }

          if (this.prevFrame) {
            const flow = this.calculateFlow();

            // Detectar rotación: combinar visión + sensor
            this.isRotating = flow.isRotating || this.sensorRotating;

            // Si está rotando, IGNORAR expansión
            const expansionToUse = this.isRotating ? 0 : flow.expansion;

            // Suavizar
            this.smoothFlowZ =
              this.smoothFlowZ * this.data.smoothing +
              expansionToUse * (1 - this.data.smoothing);
            this.smoothFlowX =
              this.smoothFlowX * this.data.lateralSmoothing +
              flow.lateral * (1 - this.data.lateralSmoothing);
            // HUD
            this.hud.depthVal.setAttribute(
              "value",
              this.smoothFlowZ.toFixed(2)
            );
            this.hud.lateralVal.setAttribute(
              "value",
              this.smoothFlowX.toFixed(2)
            );

            if (this.isRotating) {
              this.hud.rotating.setAttribute("value", "Rotando: SÍ");
              this.hud.rotating.setAttribute("color", "#FF6B6B");
            } else {
              this.hud.rotating.setAttribute("value", "Rotando: NO");
              this.hud.rotating.setAttribute("color", "#00FF00");
            }
          }

          // FPS
          this.frameCount++;
          const now = Date.now();
          if (now - this.lastFpsTime > 1000) {
            this.fps = this.frameCount;
            this.hud.fps.setAttribute("value", "FPS:" + this.fps);
            this.frameCount = 0;
            this.lastFpsTime = now;
          }

          requestAnimationFrame(() => this.analyzeFrame());
        },

        // Recorre la imagen por bloques por cada bloque llama a findBlockMatch
        // para ver su movimiento. Luego calcula la expansión y el movimiento lateral.
        calculateFlow: function () {
          const blockSize = this.data.blockSize;
          const searchRange = this.data.searchRange;

          let radialContribs = [];
          let totalExpansion = 0; // <-- declarado para acumular contribuciones radiales
          let totalLateral = 0;
          let totalLateralAbs = 0;
          let totalVertical = 0;
          let totalVerticalAbs = 0;
          let validBlocksZ = 0;
          let validBlocksX = 0;

          const stepSize = blockSize;

          for (
            let by = blockSize;
            by < this.height - blockSize * 2;
            by += stepSize
          ) {
            for (
              let bx = blockSize;
              bx < this.width - blockSize * 2;
              bx += stepSize
            ) {
              const motion = this.findBlockMatch(
                bx,
                by,
                blockSize,
                searchRange
              );

              if (motion && motion.confidence > 0.5) {
                const blockCenterX = bx + blockSize / 2;
                const blockCenterY = by + blockSize / 2;
                const dx = blockCenterX - this.centerX;
                const dy = blockCenterY - this.centerY;
                const distFromCenter = Math.sqrt(dx * dx + dy * dy);

                if (distFromCenter > blockSize * 3) {
                  const radialX = dx / distFromCenter;
                  const radialY = dy / distFromCenter;
                  const radialMotion =
                    motion.dx * radialX + motion.dy * radialY;
                  const weight =
                    distFromCenter / Math.max(this.centerX, this.centerY);

                  const contrib = radialMotion * weight;
                  totalExpansion += contrib;
                  // guardar la contribución ponderada para calcular mediana
                  radialContribs.push(contrib);
                  validBlocksZ++;
                }

                const centerBandTop = this.height / 3;
                const centerBandBottom = (this.height * 2) / 3;

                if (by >= centerBandTop && by <= centerBandBottom) {
                  totalLateral += motion.dx;
                  totalLateralAbs += Math.abs(motion.dx);
                  validBlocksX++;
                }

                // acumular vertical para detectar pitch/tilt
                // usamos bloques en franja horizontal central (puedes ajustar)
                const middleBandLeft = this.width / 3;
                const middleBandRight = (this.width * 2) / 3;
                if (bx >= middleBandLeft && bx <= middleBandRight) {
                  totalVertical += motion.dy;
                  totalVerticalAbs += Math.abs(motion.dy);
                }
              }
            }
          }

          // HUD bloques
          this.hud.blocksZ.setAttribute("value", "BlqZ: " + validBlocksZ);
          this.hud.blocksX.setAttribute("value", "BlqX: " + validBlocksX);

          // Guardar para ajuste dinámico en tick()
          this.lastValidBlocksZ = validBlocksZ;
          this.lastValidBlocksX = validBlocksX;

          // calcular avgExpansion: usar mediana de contribuciones si hay suficientes
          let avgExpansion = 0;
          if (radialContribs.length >= 4) {
            radialContribs.sort((a, b) => a - b);
            const mid = Math.floor(radialContribs.length / 2);
            avgExpansion =
              radialContribs.length % 2 === 1
                ? radialContribs[mid]
                : (radialContribs[mid - 1] + radialContribs[mid]) / 2;
          } else {
            avgExpansion = validBlocksZ > 0 ? totalExpansion / validBlocksZ : 0;
          }
          const avgLateral =
            validBlocksX >= 2 ? totalLateral / validBlocksX : 0;
          const avgLateralAbs =
            validBlocksX >= 2 ? totalLateralAbs / validBlocksX : 0;
          const avgVertical =
            totalVerticalAbs > 0
              ? totalVertical /
                (totalVerticalAbs
                  ? (totalVerticalAbs / Math.abs(totalVertical)) *
                    (Math.abs(totalVertical) / totalVerticalAbs)
                  : 1)
              : 0;
          const avgVerticalAbs =
            totalVerticalAbs > 0
              ? totalVerticalAbs /
                ((this.width / blockSize) * (this.height / blockSize))
              : 0;

          // coherencia lateral
          const lateralCoherence =
            avgLateralAbs > 0 ? Math.abs(avgLateral) / avgLateralAbs : 0;
          // coherencia vertical
          const verticalCoherence =
            avgVerticalAbs > 0 ? Math.abs(avgVertical) / avgVerticalAbs : 0;

          const lateralRotCandidate =
            lateralCoherence > 0.7 && avgLateralAbs > 0.5;
          const verticalRotCandidate =
            verticalCoherence > 0.7 && avgVerticalAbs > 0.5;

          // histéresis simple: incrementar contador si candidato, decrementar si no
          if (lateralRotCandidate || verticalRotCandidate) {
            this.rotationCounter = Math.min(4, this.rotationCounter + 1);
          } else {
            this.rotationCounter = Math.max(0, this.rotationCounter - 1);
          }

          const isRotating = this.rotationCounter >= 2;

          return {
            expansion: avgExpansion,
            lateral: avgLateral,
            isRotating: isRotating,
          };
        },

        findBlockMatch: function (bx, by, blockSize, searchRange) {
          let bestMatch = { dx: 0, dy: 0, error: Infinity, confidence: 0 };

          let blockVariance = 0;
          for (let dy = 0; dy < blockSize; dy++) {
            for (let dx = 0; dx < blockSize; dx++) {
              const idx = ((by + dy) * this.width + (bx + dx)) * 4;
              const intensity =
                (this.prevFrame.data[idx] +
                  this.prevFrame.data[idx + 1] +
                  this.prevFrame.data[idx + 2]) /
                3;
              blockVariance += intensity;
            }
          }
          blockVariance /= blockSize * blockSize;

          if (blockVariance < 20 || blockVariance > 235) {
            return null;
          }

          for (let dy = -searchRange; dy <= searchRange; dy++) {
            for (let dx = -searchRange; dx <= searchRange; dx++) {
              const error = this.compareBlocks(
                bx,
                by,
                bx + dx,
                by + dy,
                blockSize
              );

              if (error < bestMatch.error) {
                bestMatch = { dx, dy, error, confidence: 0 };
              }
            }
          }

          const maxError = blockSize * blockSize * 150;
          bestMatch.confidence = Math.max(0, 1 - bestMatch.error / maxError);

          if (bestMatch.dx === 0 && bestMatch.dy === 0) {
            return null;
          }

          return bestMatch;
        },

        // Compara dos bloques por pixeles si los colores RGB son muy diferentes
        // le suma un error alto para descartarlo y no contarlo como desplazamiento
        compareBlocks: function (x1, y1, x2, y2, size) {
          let totalError = 0;
          let count = 0;

          for (let dy = 0; dy < size; dy++) {
            for (let dx = 0; dx < size; dx++) {
              const px2 = x2 + dx;
              const py2 = y2 + dy;

              if (
                px2 < 0 ||
                px2 >= this.width ||
                py2 < 0 ||
                py2 >= this.height
              ) {
                totalError += 255;
                count++;
                continue;
              }

              const idx1 = ((y1 + dy) * this.width + (x1 + dx)) * 4;
              const idx2 = (py2 * this.width + px2) * 4;

              const i1 =
                (this.prevFrame.data[idx1] +
                  this.prevFrame.data[idx1 + 1] +
                  this.prevFrame.data[idx1 + 2]) /
                3;
              const i2 =
                (this.currFrame.data[idx2] +
                  this.currFrame.data[idx2 + 1] +
                  this.currFrame.data[idx2 + 2]) /
                3;

              totalError += Math.abs(i2 - i1);
              count++;
            }
          }

          return count > 0 ? totalError / count : Infinity;
        },

        tick: function (time, timeDelta) {
          const delta = Math.min(timeDelta / 1000, 0.1);
          if (delta <= 0) return;

          // Umbrales antiruido
          const effectiveZ =
            Math.abs(this.smoothFlowZ) > this.data.thresholdZ
              ? this.smoothFlowZ
              : 0;
          const effectiveX =
            Math.abs(this.smoothFlowX) > this.data.thresholdX
              ? this.smoothFlowX
              : 0;

          const targetVelZ =
            effectiveZ * this.data.speedZ * this.data.sensitivityZ;
          const targetVelX =
            effectiveX * this.data.speedX * this.data.sensitivityX;

          // ===== Ajuste dinámico para Z =====
          // si hay muchos bloques válidos aumentamos la ganancia (más confianza -> más respuesta)
          const blocksZ = this.lastValidBlocksZ || 0;
          // factor entre ~0.5 (pocos bloques) y 2.5 (muchos)
          const gainZ = Math.min(2.5, Math.max(0.5, 0.5 + blocksZ / 6));
          const scaledTargetVelZ = targetVelZ * gainZ;

          // Si Z domina claramente, reducir influencia lateral
          const zDominance =
            Math.abs(effectiveZ) > Math.max(0.12, Math.abs(effectiveX) * 2.5);
          const adjustedTargetVelX = zDominance
            ? targetVelX * 0.25
            : targetVelX;

          this.velocityZ += (scaledTargetVelZ - this.velocityZ) * 0.3;

          // Suavizado lateral más fuerte: deadzone, menor ganancia y clamp
          const deadzoneX = 0.05; // ajustar: ignorar micro-movimientos en X (0.02..0.1)
          const lateralTarget =
            Math.abs(effectiveX) > deadzoneX ? adjustedTargetVelX : 0;
          // menor ganancia para evitar saltos al mover lentamente el móvil
          this.velocityX += (lateralTarget - this.velocityX) * 0.12;

          if (zDominance) this.velocityX *= 0.7;

          // aplicar fricción
          this.velocityZ *= this.data.friction;
          this.velocityX *= this.data.friction;

          // limitar cambios bruscos en X (ajustar maxVelX)
          const maxVelX = 0.6;
          this.velocityX = THREE.MathUtils.clamp(
            this.velocityX,
            -maxVelX,
            maxVelX
          );

          const rigObj = this.el.object3D;

          // === Si estás rotando, puedes seguir como ya tienes el filtro ===
          // (si quieres, aquí NO retornes, solo pones velocidades a 0 cuando gires fuerte)
          if (this.isRotating) {
            this.velocityZ = 0;
            this.velocityX = 0;
            // dejamos que el HUD se actualice más abajo
          }

          this.camEl.object3D.getWorldDirection(this._forward);
          this._forward.y = 0; // 👈 eliminar componente vertical
          if (this._forward.lengthSq() < 1e-4) {
            this._forward.set(0, 0, -1); // seguridad
          }
          this._forward.normalize();

          this._right.crossVectors(this._forward, this._up).normalize();

          rigObj.position.addScaledVector(
            this._forward,
            -this.velocityZ * delta
          );
          rigObj.position.addScaledVector(this._right, this.velocityX * delta);

          rigObj.position.z = THREE.MathUtils.clamp(rigObj.position.z, -50, 50);
          rigObj.position.x = THREE.MathUtils.clamp(rigObj.position.x, -50, 50);

          rigObj.position.y = 1.6; // 👈 mantener Y fija siempre

          this.hud.pos.setAttribute(
            "value",
            "X:" +
              rigObj.position.x.toFixed(1) +
              " Z:" +
              rigObj.position.z.toFixed(1)
          );

          if (this.robotEl && this.hud.robotPos) {
            const r = this.robotEl.object3D.position;
            this.hud.robotPos.setAttribute(
              "value",
              "Robot: X:" +
                r.x.toFixed(1) +
                " Y:" +
                r.y.toFixed(1) +
                " Z:" +
                r.z.toFixed(1)
            );
          }

          // ========== DEBUG HUD ==========
          // Barras
          const barMax = 0.38;
          const barWidthZ = Math.min(barMax / 2, Math.abs(effectiveZ) * 5);
          const barWidthX = Math.min(barMax / 2, Math.abs(effectiveX) * 0.1);

          this.hud.barDepth.setAttribute("width", barWidthZ);
          this.hud.barDepth.object3D.position.x =
            effectiveZ > 0 ? barWidthZ / 2 : -barWidthZ / 2;

          this.hud.barLateral.setAttribute("width", barWidthX);
          this.hud.barLateral.object3D.position.x =
            effectiveX > 0 ? barWidthX / 2 : -barWidthX / 2;

          // Labels Z
          if (Math.abs(effectiveZ) > this.data.thresholdZ) {
            if (effectiveZ > 0) {
              this.hud.barDepth.setAttribute("color", "#00FF00");
              this.hud.depth.setAttribute("value", "→ AVANZA");
              this.hud.depth.setAttribute("color", "#00FF00");
            } else {
              this.hud.barDepth.setAttribute("color", "#FF6B6B");
              this.hud.depth.setAttribute("value", "← RETRO");
              this.hud.depth.setAttribute("color", "#FF6B6B");
            }
          } else {
            this.hud.barDepth.setAttribute("width", 0);
            this.hud.depth.setAttribute("value", "QUIETO");
            this.hud.depth.setAttribute("color", "#999");
          }

          // Labels X
          if (Math.abs(effectiveX) > this.data.thresholdX) {
            if (effectiveX > 0) {
              this.hud.barLateral.setAttribute("color", "#4CC3D9");
              this.hud.lateral.setAttribute("value", "→ DER");
              this.hud.lateral.setAttribute("color", "#4CC3D9");
            } else {
              this.hud.barLateral.setAttribute("color", "#FFC65D");
              this.hud.lateral.setAttribute("value", "← IZQ");
              this.hud.lateral.setAttribute("color", "#FFC65D");
            }
          } else {
            this.hud.barLateral.setAttribute("width", 0);
            this.hud.lateral.setAttribute("value", "CENTRO");
            this.hud.lateral.setAttribute("color", "#999");
          }
        },
      });

      // CÁMARA
      const video = document.getElementById("cam");
      navigator.mediaDevices
        .getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 },
          },
        })
        .then((stream) => {
          video.srcObject = stream;
          video.play();
          console.log("✓ Cámara OK");
        })
        .catch((error) => {
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then((stream) => {
              video.srcObject = stream;
              video.play();
            });
        });
    </script>
  </body>
</html>
