<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AR con retículo + mensajes</title>

<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.3.0/dist/aframe-ar-hit-test-component.min.js"></script>

<style>
  html,body{margin:0;height:100%}
  #start,#recolocar{
    position:fixed;left:50%;transform:translateX(-50%);
    z-index:30;padding:12px 16px;font:600 16px system-ui;border:0;border-radius:12px;
    background:#0ea5e9;color:#fff;box-shadow:0 10px 28px rgba(0,0,0,.25);cursor:pointer
  }
  #start{top:50%}
  #recolocar{bottom:16px;display:none}
  #hud{
    position:fixed;left:0;right:0;top:0;padding:.6rem 1rem;z-index:25;
    color:#fff;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent);
    font:600 14px/1.2 system-ui;pointer-events:none
  }
  a-scene{background:transparent !important}
</style>
</head>
<body>

<div id="hud">Pulsa “Iniciar AR”. Mueve el móvil para encontrar la mesa…</div>
<button id="start">Iniciar AR</button>
<button id="recolocar">Recolocar</button>

<a-scene id="scene"
  embedded
  renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true; alpha:true"
  webxr="mode: ar"
  vr-mode-ui="enabled:false"
  xr-mode-ui="enabled:false"
  loading-screen="enabled:false"
  ar-hit-test="target:#cubo; type: map; mapSize:0.35 0.35">
  <!-- luces -->
  <a-entity light="type:ambient; intensity:0.8"></a-entity>
  <a-entity light="type:directional; intensity:1.0" position="0 2 1"></a-entity>

  <!-- Texto 3D pegado a la cámara (fallback si no hay DOM overlay) -->
  <a-entity id="status3d" position="0 -0.3 -1"
            text="value: esperando...; align: center; color: #ffffff; width: 2"></a-entity>
  <a-entity camera look-controls wasd-controls></a-entity>

  <!-- Objeto a colocar -->
  <a-box id="cubo" visible="false"
         depth="0.2" height="0.2" width="0.2"
         material="color:#FF6A00; metalness:0.2; roughness:0.6"></a-box>
</a-scene>

<script>
const scene = document.getElementById('scene');
const startBtn = document.getElementById('start');
const recolocarBtn = document.getElementById('recolocar');
const cubo = document.getElementById('cubo');
const hud = document.getElementById('hud');
const status3d = document.getElementById('status3d');

// Utilidad para mostrar mensaje en HUD y en texto 3D
function showMsg(m){
  hud.textContent = m;
  status3d.setAttribute('text', 'value', m);
}

async function startAR(){
  if (!('xr' in navigator)) { alert('navigator.xr no disponible'); return; }
  const ok = await navigator.xr.isSessionSupported('immersive-ar');
  if (!ok) { alert('Este navegador no soporta immersive-ar'); return; }

  // Pedimos dom-overlay como OPCIONAL (no bloquea si no existe)
  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test','local-floor'],
    optionalFeatures: ['dom-overlay'],
    domOverlay: { root: document.body } // si el navegador admite overlay, usará el <body>
  });

  const gl = scene.renderer.getContext();
  if (gl.makeXRCompatible) await gl.makeXRCompatible();
  scene.renderer.xr.setSession(session);

  // Disparamos 'enter-vr' para que el ar-hit-test se active sí o sí
  scene.emit('enter-vr');

  startBtn.style.display = 'none';
  showMsg('Buscando superficie… mueve el móvil');

  // Eventos del hit-test en la propia escena (el componente los reemite)
  scene.addEventListener('ar-hit-test-start', ()=> showMsg('Buscando superficie…'));
  scene.addEventListener('ar-hit-test-achieved', ()=> showMsg('Superficie detectada. Toca para colocar.'));
  scene.addEventListener('ar-hit-test-select', ()=> showMsg('Colocado. Pulsa “Recolocar” para moverlo.'));

  session.addEventListener('end', () => {
    scene.emit('exit-vr');
    startBtn.style.display = 'inline-block';
    recolocarBtn.style.display = 'none';
    cubo.setAttribute('visible', false);
    showMsg('Pulsa “Iniciar AR”. Mueve el móvil para encontrar la mesa…');
  });
}

// Mostrar botón “Recolocar” cuando el cubo ya está visible
cubo.addEventListener('componentchanged', (e) => {
  if (e.detail.name === 'visible' && cubo.getAttribute('visible')) {
    recolocarBtn.style.display = 'inline-block';
  }
});

// Recolocar: ocultamos el cubo; el siguiente toque lo vuelve a ubicar
recolocarBtn.addEventListener('click', () => {
  cubo.setAttribute('visible', false);
  recolocarBtn.style.display = 'none';
  showMsg('Superficie detectada. Toca para colocar.');
});

startBtn.addEventListener('click', () => {
  startAR().catch(e => alert('No se pudo iniciar AR: ' + (e?.message || e)));
});

// Mensaje inicial
showMsg('Pulsa “Iniciar AR”. Mueve el móvil para encontrar la mesa…');
</script>
</body>
</html>
