<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR con Movimiento por Aceler√≥metro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      
      /* Bot√≥n para solicitar permisos iOS */
      #permission-btn {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 40px;
        font-size: 18px;
        background: #FF6B6B;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }
      
      #permission-btn:hover {
        background: #FF5252;
      }
      
      /* Panel de debug */
      #debug-panel {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        border-radius: 5px;
        z-index: 999;
        max-width: 300px;
      }
      
      .debug-value {
        margin: 5px 0;
      }
      
      .debug-bar {
        height: 20px;
        background: #333;
        border-radius: 3px;
        margin: 3px 0;
        position: relative;
        overflow: hidden;
      }
      
      .debug-bar-fill {
        height: 100%;
        background: #4CC3D9;
        transition: width 0.1s;
      }
    </style>
  </head>
  <body>
    <!-- Bot√≥n de permisos (solo visible en iOS) -->
    <button id="permission-btn">Activar Sensores</button>
    
    <!-- Panel de debug -->
    <div id="debug-panel">
      <div style="font-weight: bold; margin-bottom: 10px;">üì± Sensores de Movimiento</div>
      <div class="debug-value">Posici√≥n Z: <span id="pos-z">0.00</span>m</div>
      <div class="debug-value">Posici√≥n X: <span id="pos-x">0.00</span>m</div>
      <div class="debug-value">Velocidad: <span id="velocity">0.00</span>m/s</div>
      <div class="debug-value">Aceleraci√≥n:</div>
      <div class="debug-bar">
        <div class="debug-bar-fill" id="accel-bar" style="width: 50%;"></div>
      </div>
      <div class="debug-value" style="margin-top: 10px;">
        Estado: <span id="status" style="color: #4CC3D9;">Esperando...</span>
      </div>
    </div>

    <!-- Video de c√°mara (oculto) -->
    <video id="cam" autoplay muted playsinline style="display: none;"></video>

    <a-scene>
      <!-- Cuadr√≠cula de referencia en el suelo -->
      <a-plane rotation="-90 0 0"
               width="50" height="50"
               position="0 0 0"
               color="#1a1a1a"
               material="shader: flat; wireframe: true; wireframeLinewidth: 2">
      </a-plane>

      <!-- Objetos de referencia para ver el movimiento -->
      <a-box position="0 1 -5" color="#FF6B6B" shadow="cast: true;" 
             animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
      </a-box>
      
      <a-sphere position="3 1 -5" radius="0.5" color="#4CC3D9"></a-sphere>
      <a-sphere position="-3 1 -5" radius="0.5" color="#FFC65D"></a-sphere>
      
      <a-box position="0 1 -10" color="#00FF00" width="2" height="2" depth="2"></a-box>
      <a-box position="5 1 -8" color="#FF00FF"></a-box>
      <a-box position="-5 1 -8" color="#00FFFF"></a-box>

      <!-- Luz direccional -->
      <a-light type="directional" intensity="0.6" position="2 4 2" shadow="cast: true;"></a-light>
      <a-light type="ambient" intensity="0.4"></a-light>

      <!-- Suelo con sombras -->
      <a-plane rotation="-90 0 0"
               width="100" height="100"
               color="#2a2a2a"
               material="shader: standard"
               shadow="receive: true">
      </a-plane>

      <!-- RIG con movimiento por aceler√≥metro -->
      <a-entity id="rig"
                position="0 1.6 0"
                mobile-movement>

        <!-- C√°mara con video de fondo -->
        <a-entity camera look-controls="pointerLockEnabled: false; touchEnabled: true">
          <!-- Cursor opcional -->
          <a-cursor></a-cursor>

          <!-- Plano-video pegado al visor -->
          <a-plane id="video-plane"
                   position="0 0 -5"
                   width="15" height="13"
                   material="shader: flat; src: #cam; transparent: true; opacity: 0.8">
          </a-plane>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      // ========================================
      // COMPONENTE DE MOVIMIENTO POR ACELER√ìMETRO
      // ========================================
      AFRAME.registerComponent('mobile-movement', {
        schema: {
          acceleration: { type: 'number', default: 0.15 },
          friction: { type: 'number', default: 0.92 },
          maxSpeed: { type: 'number', default: 5 },
          smoothing: { type: 'number', default: 0.8 },
          threshold: { type: 'number', default: 0.3 }
        },

        init: function() {
          // Vectores de f√≠sica
          this.velocity = new THREE.Vector3(0, 0, 0);
          this.acceleration = new THREE.Vector3(0, 0, 0);
          this.smoothedAccel = new THREE.Vector3(0, 0, 0);
          
          // Variables de estado
          this.hasPermission = false;
          this.isMoving = false;
          this.deviceOrientation = new THREE.Euler();
          
          // Referencias a elementos UI
          this.debugPosZ = document.getElementById('pos-z');
          this.debugPosX = document.getElementById('pos-x');
          this.debugVelocity = document.getElementById('velocity');
          this.debugAccelBar = document.getElementById('accel-bar');
          this.debugStatus = document.getElementById('status');
          
          // Solicitar permisos
          this.requestPermissions();
        },

        requestPermissions: function() {
          const btn = document.getElementById('permission-btn');
          
          // Verificar si necesitamos solicitar permisos (iOS 13+)
          if (typeof DeviceMotionEvent !== 'undefined' && 
              typeof DeviceMotionEvent.requestPermission === 'function') {
            
            btn.style.display = 'block';
            this.debugStatus.textContent = 'Toca el bot√≥n para activar';
            this.debugStatus.style.color = '#FFC65D';
            
            btn.addEventListener('click', () => {
              DeviceMotionEvent.requestPermission()
                .then(response => {
                  if (response === 'granted') {
                    this.startSensors();
                    btn.style.display = 'none';
                  } else {
                    alert('Permisos denegados. Necesitas activar los sensores de movimiento.');
                  }
                })
                .catch(error => {
                  console.error('Error solicitando permisos:', error);
                  alert('Error: ' + error.message);
                });
            });
          } else {
            // Android o navegador compatible
            this.startSensors();
          }
        },

        startSensors: function() {
          this.hasPermission = true;
          this.debugStatus.textContent = 'Activo ‚úì';
          this.debugStatus.style.color = '#00FF00';
          
          // Listener de aceleraci√≥n (movimiento lineal)
          window.addEventListener('devicemotion', (event) => {
            if (event.acceleration) {
              const threshold = this.data.threshold;
              
              // Leer aceleraci√≥n (m/s¬≤)
              let ax = event.acceleration.x || 0;
              let ay = event.acceleration.y || 0;
              let az = event.acceleration.z || 0;
              
              // Filtrar ruido (umbral)
              ax = Math.abs(ax) > threshold ? ax : 0;
              ay = Math.abs(ay) > threshold ? ay : 0;
              az = Math.abs(az) > threshold ? az : 0;
              
              // Invertir ejes seg√∫n orientaci√≥n del dispositivo
              // (ajustar seg√∫n c√≥mo sostengas el m√≥vil)
              this.acceleration.set(-ax, ay, az);
              
              this.isMoving = (Math.abs(ax) + Math.abs(ay) + Math.abs(az)) > threshold;
            }
          }, true);

          // Listener de orientaci√≥n (rotaci√≥n del dispositivo)
          window.addEventListener('deviceorientation', (event) => {
            // Obtener √°ngulos Euler del dispositivo
            const alpha = THREE.MathUtils.degToRad(event.alpha || 0); // Z
            const beta = THREE.MathUtils.degToRad(event.beta || 0);   // X
            const gamma = THREE.MathUtils.degToRad(event.gamma || 0); // Y
            
            this.deviceOrientation.set(beta, alpha, -gamma, 'YXZ');
          }, true);
          
          console.log('‚úì Sensores de movimiento activados');
        },

        tick: function(time, timeDelta) {
          if (!this.hasPermission) return;
          
          const delta = timeDelta / 1000; // Convertir a segundos
          if (delta > 0.1) return; // Ignorar deltas muy grandes
          
          // Aplicar suavizado a la aceleraci√≥n
          this.smoothedAccel.lerp(this.acceleration, this.data.smoothing);
          
          // Obtener la rotaci√≥n de la c√°mara (hacia d√≥nde mira)
          const camera = this.el.querySelector('[camera]');
          const cameraRotation = camera ? camera.object3D.rotation : new THREE.Euler();
          
          // Crear matriz de rotaci√≥n basada en la orientaci√≥n de la c√°mara
          const quaternion = new THREE.Quaternion();
          quaternion.setFromEuler(cameraRotation);
          
          // Transformar la aceleraci√≥n al espacio de la c√°mara
          const worldAccel = this.smoothedAccel.clone();
          worldAccel.applyQuaternion(quaternion);
          
          // Integrar: aceleraci√≥n -> velocidad
          this.velocity.x += worldAccel.x * this.data.acceleration * delta;
          this.velocity.z += worldAccel.z * this.data.acceleration * delta;
          // No movemos en Y (arriba/abajo) para mantener altura constante
          
          // Aplicar fricci√≥n
          this.velocity.multiplyScalar(this.data.friction);
          
          // Limitar velocidad m√°xima
          const speed = this.velocity.length();
          if (speed > this.data.maxSpeed) {
            this.velocity.normalize().multiplyScalar(this.data.maxSpeed);
          }
          
          // Integrar: velocidad -> posici√≥n
          const pos = this.el.object3D.position;
          pos.x += this.velocity.x * delta;
          pos.z += this.velocity.z * delta;
          
          // Opcional: limitar √°rea de movimiento
          const maxDistance = 20;
          pos.x = THREE.MathUtils.clamp(pos.x, -maxDistance, maxDistance);
          pos.z = THREE.MathUtils.clamp(pos.z, -maxDistance, maxDistance);
          
          // Actualizar UI de debug
          this.updateDebugUI(pos, speed);
        },

        updateDebugUI: function(pos, speed) {
          // Actualizar valores
          this.debugPosZ.textContent = pos.z.toFixed(2);
          this.debugPosX.textContent = pos.x.toFixed(2);
          this.debugVelocity.textContent = speed.toFixed(2);
          
          // Actualizar barra de aceleraci√≥n (0-100%)
          const accelMagnitude = this.smoothedAccel.length();
          const percentage = Math.min(100, (accelMagnitude / 5) * 100);
          this.debugAccelBar.style.width = percentage + '%';
          
          // Cambiar color seg√∫n intensidad
          if (percentage > 70) {
            this.debugAccelBar.style.background = '#FF6B6B';
          } else if (percentage > 30) {
            this.debugAccelBar.style.background = '#FFC65D';
          } else {
            this.debugAccelBar.style.background = '#4CC3D9';
          }
          
          // Estado de movimiento
          if (this.isMoving) {
            this.debugStatus.textContent = 'En movimiento ‚ÜîÔ∏è';
            this.debugStatus.style.color = '#00FF00';
          } else {
            this.debugStatus.textContent = 'Est√°tico ‚è∏Ô∏è';
            this.debugStatus.style.color = '#999';
          }
        }
      });

      // ========================================
      // INICIALIZACI√ìN DE C√ÅMARA
      // ========================================
      const video = document.getElementById('cam');

      navigator.mediaDevices.getUserMedia({
        video: { 
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      }).then(function (stream) {
        video.srcObject = stream;
        video.play();
        console.log('‚úì C√°mara trasera activada');
      }).catch(function (error) {
        console.warn("C√°mara trasera no disponible, usando la frontal.", error);
        navigator.mediaDevices.getUserMedia({ 
          video: true 
        }).then(function (stream) {
          video.srcObject = stream;
          video.play();
          console.log('‚úì C√°mara frontal activada');
        }).catch(function(err) {
          console.error('Error accediendo a la c√°mara:', err);
          alert('No se pudo acceder a la c√°mara');
        });
      });

      // ========================================
      // CONTROLES DE TECLADO (para pruebas en PC)
      // ========================================
      document.addEventListener('keydown', (e) => {
        const rig = document.getElementById('rig');
        const pos = rig.object3D.position;
        const speed = 0.2;
        
        switch(e.key) {
          case 'w':
          case 'ArrowUp':
            pos.z -= speed;
            break;
          case 's':
          case 'ArrowDown':
            pos.z += speed;
            break;
          case 'a':
          case 'ArrowLeft':
            pos.x -= speed;
            break;
          case 'd':
          case 'ArrowRight':
            pos.x += speed;
            break;
        }
      });

      // ========================================
      // INFORMACI√ìN DE INICIO
      // ========================================
      console.log('='.repeat(50));
      console.log('üéÆ AR con Movimiento por Aceler√≥metro');
      console.log('='.repeat(50));
      console.log('üì± Mueve tu dispositivo para desplazarte');
      console.log('üéØ Mira alrededor arrastrando el dedo');
      console.log('‚å®Ô∏è  PC: Usa WASD o flechas para moverte');
      console.log('='.repeat(50));
    </script>
  </body>
</html>