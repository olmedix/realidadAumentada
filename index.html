<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Minimal WebXR AR</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background: #000;
      }
      #btn {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        padding: 12px 16px;
        font: 600 16px system-ui;
        border: 0;
        border-radius: 10px;
        background: #0ea5e9;
        color: #fff;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25);
        cursor: pointer;
      }
      #log {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        max-height: 40vh;
        overflow: auto;
        background: rgba(0, 0, 0, 0.7);
        color: #0ff;
        font: 12px ui-monospace, monospace;
        padding: 0.5rem;
      }
    </style>
  </head>
  <body>
    <button id="btn">Iniciar AR</button>
    <pre id="log"></pre>
    <script>
      const $ = (s) => document.querySelector(s);
      const log = (...m) => {
        $("#log").textContent += m.join(" ") + "\n";
      };

      let gl, xrSession, refSpace;

      function initGL() {
        if (gl) return;
        const canvas = document.createElement("canvas");
        document.body.appendChild(canvas);
        gl = canvas.getContext("webgl", { alpha: true, antialias: true });
        // Canvas al tamaño de la ventana (XR gestiona el viewport por vista)
        const onResize = () => {
          canvas.width = innerWidth;
          canvas.height = innerHeight;
        };
        addEventListener("resize", onResize);
        onResize();
      }

      async function startAR() {
        if (!("xr" in navigator)) {
          alert("navigator.xr no disponible");
          return;
        }
        const supported = await navigator.xr.isSessionSupported("immersive-ar");
        log("immersive-ar soportado:", supported);
        if (!supported) {
          alert("Este navegador no soporta AR");
          return;
        }

        xrSession = await navigator.xr.requestSession("immersive-ar", {
          optionalFeatures: ["local-floor", "hit-test"], // no son obligatorias
        });

        initGL();
        await gl.makeXRCompatible?.(); // algunos navegadores lo requieren
        xrSession.updateRenderState({
          baseLayer: new XRWebGLLayer(xrSession, gl),
        });

        refSpace = await xrSession.requestReferenceSpace("local"); // origen suave
        xrSession.addEventListener("end", () => {
          $("#btn").style.display = "block";
          log("Sesión terminada");
        });

        $("#btn").style.display = "none";
        xrSession.requestAnimationFrame(onXRFrame);
      }

      function onXRFrame(t, frame) {
        const session = frame.session;
        session.requestAnimationFrame(onXRFrame);

        const pose = frame.getViewerPose(refSpace);
        if (!pose) return;

        const glLayer = session.renderState.baseLayer;

        // Limpia con alpha=0 → deja ver el mundo real (passthrough de cámara)
        gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
        gl.clearColor(0, 0, 0, 0);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        // (Aquí dibujarías tus objetos por cada "view" si quisieras)
        for (const view of pose.views) {
          const viewport = glLayer.getViewport(view);
          gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
          // …tu render aquí (matrices view.projectionMatrix, view.transform.inverse.matrix)
        }
      }

      $("#btn").addEventListener("click", startAR);

      // info inicial
      log("HTTPS:", location.protocol === "https:");
      log("UserAgent:", navigator.userAgent);
    </script>
  </body>
</html>
