<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR con retículo visible</title>

  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.3.0/dist/aframe-ar-hit-test-component.min.js"></script>

  <style>
    html,body{margin:0;height:100%}
    #start,#recolocar{
      position:fixed;left:50%;transform:translateX(-50%);
      z-index:20;padding:12px 16px;font:600 16px system-ui;border:0;border-radius:12px;
      background:#0ea5e9;color:#fff;box-shadow:0 10px 28px rgba(0,0,0,.25);cursor:pointer
    }
    #start{top:50%}
    #recolocar{bottom:16px;display:none}
    #hint{
      position:fixed;left:0;right:0;top:0;padding:.6rem 1rem;z-index:10;
      color:#fff;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent);
      font:600 14px/1.2 system-ui;pointer-events:none
    }
    a-scene{background:transparent !important}
  </style>
</head>
<body>
  <!-- imagen para el retículo (anillo) -->
  <img id="ret-img" src="https://raw.githubusercontent.com/aframevr/aframe/master/docs/components/images/reticle-gray.png" alt="" style="display:none">

  <div id="hint">Mueve el móvil para encontrar la mesa…</div>
  <button id="start">Iniciar AR</button>
  <button id="recolocar">Recolocar</button>

  <a-scene
    embedded
    renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true; alpha:true"
    webxr="mode: ar; optionalFeatures: hit-test, local-floor"
    vr-mode-ui="enabled: false"
    xr-mode-ui="enabled: false"
    loading-screen="enabled:false"
    <!-- ✅ ar-hit-test en la ESCENA, con retículo grande -->
    ar-hit-test="target:#cubo; src:#ret-img; type: map; mapSize: 0.28 0.28">

    <!-- Luces -->
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:1.0" position="0 2 1"></a-entity>

    <!-- El objeto (oculto hasta colocar) -->
    <a-box id="cubo" visible="false"
           depth="0.2" height="0.2" width="0.2"
           material="color:#FF6A00; metalness:0.2; roughness:0.6">
    </a-box>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const startBtn = document.getElementById('start');
    const recolocarBtn = document.getElementById('recolocar');
    const cubo = document.getElementById('cubo');
    const hint = document.getElementById('hint');

    // Pedir la sesión AR DIRECTAMENTE (evita VR)
    async function startARSession() {
      if (!('xr' in navigator)) { alert('navigator.xr no disponible'); return; }
      const ok = await navigator.xr.isSessionSupported('immersive-ar');
      if (!ok) { alert('Este navegador no soporta AR (immersive-ar).'); return; }
      const session = await navigator.xr.requestSession('immersive-ar', {
        optionalFeatures: ['hit-test','local-floor']
      });
      const gl = scene.renderer.getContext();
      if (gl.makeXRCompatible) await gl.makeXRCompatible();
      scene.renderer.xr.setSession(session);
      startBtn.style.display = 'none';

      // Logs visuales para saber si hay plano
      scene.addEventListener('ar-hit-test-start', ()=>{ hint.textContent = 'Buscando superficie…'; });
      scene.addEventListener('ar-hit-test-achieved', ()=>{ hint.textContent = 'Superficie detectada. Toca para colocar.'; });
      scene.addEventListener('ar-hit-test-select', ()=>{ hint.textContent = 'Colocado. Pulsa “Recolocar” para moverlo.'; });

      session.addEventListener('end', () => {
        startBtn.style.display = 'inline-block';
        recolocarBtn.style.display = 'none';
        cubo.setAttribute('visible', false);
        hint.textContent = 'Mueve el móvil para encontrar la mesa…';
      });
    }

    startBtn.addEventListener('click', () => {
      startARSession().catch(e => alert('No se pudo iniciar AR: ' + (e?.message || e)));
    });

    // Mostrar “Recolocar” cuando el objeto pase a visible (ya colocado)
    cubo.addEventListener('componentchanged', (e) => {
      if (e.detail.name === 'visible' && cubo.getAttribute('visible')) {
        recolocarBtn.style.display = 'inline-block';
      }
    });

    // Recolocar: ocultamos el cubo, el próximo toque lo reubica
    recolocarBtn.addEventListener('click', () => {
      cubo.setAttribute('visible', false);
      recolocarBtn.style.display = 'none';
      hint.textContent = 'Superficie detectada. Toca para colocar.';
    });
  </script>
</body>
</html>
